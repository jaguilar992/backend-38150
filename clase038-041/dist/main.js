(()=>{"use strict";var e={n:n=>{var t=n&&n.__esModule?()=>n.default:()=>n;return e.d(t,{a:t}),t},d:(n,t)=>{for(var o in t)e.o(t,o)&&!e.o(n,o)&&Object.defineProperty(n,o,{enumerable:!0,get:t[o]})},o:(e,n)=>Object.prototype.hasOwnProperty.call(e,n)};const n=require("express");var t=e.n(n);const o=require("cors"),i=require("mongoose");var r=e.n(i);const s=require("dotenv");e.n(s)().config();const a=process.env.PORT||8080,d=(process.env.BASE_URL,process.env.DATABASE_TYPE||"MONGO");class u{constructor(){}static getInstance(){return e=this,n=void 0,o=function*(){if(!u.connected)try{return yield r().connect("mongodb://localhost:27017/pokemon"),u.connected=!0,!0}catch(e){return console.log(e),!1}return u.instance},new((t=void 0)||(t=Promise))((function(i,r){function s(e){try{d(o.next(e))}catch(e){r(e)}}function a(e){try{d(o.throw(e))}catch(e){r(e)}}function d(e){var n;e.done?i(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(s,a)}d((o=o.apply(e,n||[])).next())}));var e,n,t,o}}u.connected=!1;const c=u.getInstance,l=require("pino"),f=e.n(l)()();var v=function(e,n,t,o){return new(t||(t=Promise))((function(i,r){function s(e){try{d(o.next(e))}catch(e){r(e)}}function a(e){try{d(o.throw(e))}catch(e){r(e)}}function d(e){var n;e.done?i(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(s,a)}d((o=o.apply(e,n||[])).next())}))};const m=new i.Schema({id:{type:Number,required:!0,default:0},name:{type:String,required:!0,default:""},type:{type:String,required:!0,default:""},image:{type:String,required:!0,default:""}}),p=(0,i.model)("pokemon",m);class h{getAllPokemons(){return v(this,void 0,void 0,(function*(){return yield p.find()}))}getPokemonById(e){return v(this,void 0,void 0,(function*(){return yield p.findOne({id:e})}))}createPokemon(e){return v(this,void 0,void 0,(function*(){const n=new p(e);return yield n.save(),n}))}updatePokemon(e,n){return v(this,void 0,void 0,(function*(){return yield p.findOneAndUpdate({id:e},n)}))}deletePokemon(e){return v(this,void 0,void 0,(function*(){return yield p.deleteOne({id:e}),!0}))}}new h;const y=new class{getDAO(){switch(d){case"MONGO":this.pokemonDAO=new h;break;case"MYSQL":case"POSTGRES":case"FIREBASE":case"SQLITE":break;default:throw new Error("No se ha definido un tipo de base de datos")}return this.pokemonDAO}};var g=function(e,n,t,o){return new(t||(t=Promise))((function(i,r){function s(e){try{d(o.next(e))}catch(e){r(e)}}function a(e){try{d(o.throw(e))}catch(e){r(e)}}function d(e){var n;e.done?i(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(s,a)}d((o=o.apply(e,n||[])).next())}))};const k=new class{constructor(){this.pokemonDAO=y.getDAO()}find(){return g(this,void 0,void 0,(function*(){return yield this.pokemonDAO.getAllPokemons()}))}findOne(e){return g(this,void 0,void 0,(function*(){return yield this.pokemonDAO.getPokemonById(e)}))}save(e){return g(this,void 0,void 0,(function*(){return yield this.pokemonDAO.createPokemon(e),e}))}update(e,n){return g(this,void 0,void 0,(function*(){return yield this.pokemonDAO.updatePokemon(e,n)}))}delete(e){return g(this,void 0,void 0,(function*(){return yield this.pokemonDAO.deletePokemon(e),!0}))}},w=require("joi");var O=e.n(w);const P=O().object({name:O().string().alphanum().required(),type:O().string().alphanum().required(),image:O().string(),id:O().number().required()});var A=function(e,n,t,o){return new(t||(t=Promise))((function(i,r){function s(e){try{d(o.next(e))}catch(e){r(e)}}function a(e){try{d(o.throw(e))}catch(e){r(e)}}function d(e){var n;e.done?i(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(s,a)}d((o=o.apply(e,n||[])).next())}))};const j=(0,n.Router)();j.get("/",((e,n)=>A(void 0,void 0,void 0,(function*(){const e=yield k.find();n.json({data:e})})))),j.get("/:id",((e,n)=>A(void 0,void 0,void 0,(function*(){const{id:t}=e.params,o=yield k.findOne(t);if(!o)return n.status(404).json({message:"Pokemon not found",data:null});n.json({data:o})})))),j.post("/",((e,n)=>A(void 0,void 0,void 0,(function*(){const{id:t,name:o,type:i}=e.body,r={id:t,name:o,type:i},s=P.validate(r);if(console.log(s),s.error)return n.status(400).json({message:s.error.details,data:null});if(yield k.findOne(t))return n.status(409).json({message:"Pokemon already exists",data:null});r.image=`https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${t}.png`;const a=yield k.save(r);return n.status(201).json({data:a,message:"Pokemon has been created"})})))),j.delete("/:id",((e,n,t)=>{return o=void 0,i=void 0,s=function*(){const o=e.headers.authorization,i=null==o?void 0:o.split(" ")[1];return i?"123456"!==i?n.status(401).json({message:"Unauthorized",data:null}):(e.token=i,void t()):n.status(401).json({message:"Unauthorized",data:null})},new((r=void 0)||(r=Promise))((function(e,n){function t(e){try{d(s.next(e))}catch(e){n(e)}}function a(e){try{d(s.throw(e))}catch(e){n(e)}}function d(n){var o;n.done?e(n.value):(o=n.value,o instanceof r?o:new r((function(e){e(o)}))).then(t,a)}d((s=s.apply(o,i||[])).next())}));var o,i,r,s}),((e,n)=>A(void 0,void 0,void 0,(function*(){const{id:t}=e.params;if(!t)return n.status(400).json({message:"Bad request",data:null});const o=yield k.delete(t);n.json({message:"Pokemon has been deleted",data:o})}))));const T=j,x=(0,n.Router)();x.get("/",((e,n)=>A(void 0,void 0,void 0,(function*(){const e=yield k.find();n.render("pokedex",{pokemons:e,title:"Pokedex"})})))),x.get("/:id",((e,n)=>A(void 0,void 0,void 0,(function*(){const{id:t}=e.params,o=yield k.findOne(t);if(!o)return console.log("Pokemon not found"),n.status(404).json({message:"Pokemon not found"});n.render("pokemon",{pokemon:o,title:o.name})}))));const D=x;var b=function(e,n,t,o){return new(t||(t=Promise))((function(i,r){function s(e){try{d(o.next(e))}catch(e){r(e)}}function a(e){try{d(o.throw(e))}catch(e){r(e)}}function d(e){var n;e.done?i(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(s,a)}d((o=o.apply(e,n||[])).next())}))};const S=new i.Schema({dni:{type:Number,required:!0,default:0},name:{type:String,required:!0,default:""},city:{type:String,required:!0,default:""},age:{type:Number,required:!1,default:15},pokemons:{type:[Number],required:!1,default:[]}}),q=(0,i.model)("trainer",S);class I{getAllTrainers(){return b(this,void 0,void 0,(function*(){return yield q.find()}))}getTrainerByDNI(e){return b(this,void 0,void 0,(function*(){return yield q.findOne({dni:e})}))}createTrainer(e){return b(this,void 0,void 0,(function*(){const n=new q(e);return yield n.save(),n}))}updateTrainer(e,n){return b(this,void 0,void 0,(function*(){return yield q.findOneAndUpdate({dni:e},n)}))}deletePokemon(e){return b(this,void 0,void 0,(function*(){return yield q.deleteOne({dni:e}),!0}))}}new I;const E=new class{getDAO(){switch(d){case"MONGO":this.pokemonDAO=new I;break;case"MYSQL":case"POSTGRES":case"FIREBASE":case"SQLITE":break;default:throw new Error("No se ha definido un tipo de base de datos")}return this.pokemonDAO}};var N=function(e,n,t,o){return new(t||(t=Promise))((function(i,r){function s(e){try{d(o.next(e))}catch(e){r(e)}}function a(e){try{d(o.throw(e))}catch(e){r(e)}}function d(e){var n;e.done?i(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(s,a)}d((o=o.apply(e,n||[])).next())}))};const B=new class{constructor(){this.trainerDAO=E.getDAO()}find(){return N(this,void 0,void 0,(function*(){return yield this.trainerDAO.getAllTrainers()}))}findOne(e){var n;return N(this,void 0,void 0,(function*(){const t=yield this.trainerDAO.getTrainerByDNI(e);if(!t)return null;let o=yield null===(n=null==t?void 0:t.pokemons)||void 0===n?void 0:n.map((e=>N(this,void 0,void 0,(function*(){return yield k.findOne(e)}))));return o=yield Promise.all(o),{name:t.name,dni:t.dni,city:t.city,age:t.age,pokemons:o}}))}save(e){return N(this,void 0,void 0,(function*(){return yield this.trainerDAO.createTrainer(e)}))}addPokemonToPokedexTrainer(e,n){return N(this,void 0,void 0,(function*(){const t=yield this.trainerDAO.getTrainerByDNI(e);if(!t)throw new Error("Trainer not found");return t.pokemons.push(n),yield this.trainerDAO.updateTrainer(e,t)}))}removePokemonFromPokedexTrainer(e,n){return N(this,void 0,void 0,(function*(){const t=yield this.trainerDAO.getTrainerByDNI(e);if(!t)throw new Error("Trainer not found");return t.pokemons=t.pokemons.filter((e=>e!==n)),yield this.trainerDAO.updateTrainer(e,t)}))}update(e,n){return N(this,void 0,void 0,(function*(){return yield this.trainerDAO.updateTrainer(e,n)}))}delete(e){return N(this,void 0,void 0,(function*(){return yield this.trainerDAO.deleteTrainer(e)}))}};var M=function(e,n,t,o){return new(t||(t=Promise))((function(i,r){function s(e){try{d(o.next(e))}catch(e){r(e)}}function a(e){try{d(o.throw(e))}catch(e){r(e)}}function d(e){var n;e.done?i(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(s,a)}d((o=o.apply(e,n||[])).next())}))};const R=(0,n.Router)();R.get("/",(function(e,n){return M(this,void 0,void 0,(function*(){const e=yield B.find();n.json({data:e})}))})),R.get("/:dni",(function(e,n){return M(this,void 0,void 0,(function*(){const{dni:t}=e.params,o=yield B.findOne(t);if(!o)return console.log("Trainer not found"),n.status(404).json({message:"Trainer not found"});n.json({data:o})}))})),R.post("/",(function(e,n){return M(this,void 0,void 0,(function*(){const{dni:t,city:o,name:i}=e.body;if(!t||!o||!i)return console.log("Missing params"),n.status(400).json({message:"Missing params"});const r=yield B.save({dni:t,city:o,name:i});n.json({data:r})}))})),R.put("/addPokemon/:dni",(function(e,n){return M(this,void 0,void 0,(function*(){const{dni:t}=e.params,{pokemonId:o}=e.body;if(!t||!o)return console.log("Missing params"),n.status(400).json({message:"Missing params"});const i=yield B.addPokemonToPokedexTrainer(t,o);n.json({data:i})}))})),R.put("/removePokemon/:dni",(function(e,n){return M(this,void 0,void 0,(function*(){const{dni:t}=e.params,{pokemonId:o}=e.body;if(!t||!o)return console.log("Missing params"),n.status(400).json({message:"Missing params"});const i=yield B.removePokemonFromPokedexTrainer(t,o);n.json({data:i})}))}));const _=R,G=(0,n.Router)();G.get("/:dni",(function(e,n){return M(this,void 0,void 0,(function*(){const{dni:t}=e.params,o=yield B.findOne(t);if(!o)return console.log("Trainer not found"),n.status(404).json({message:"Trainer not found"});n.render("pokedex",{pokemons:o.pokemons,title:`${o.name}'s Pokedex`})}))}));const L=G,U=require("swagger-ui-express");var z=e.n(U);const F=require("swagger-jsdoc"),Q={definition:{openapi:"3.0.3",info:{title:"Simple Pokemon API",description:"A simple pokemon API, for the nodejs backend class",version:"1.0.1",produces:["application/json","application/xml"],securityDefinitions:{JWT:{type:"apiKey",in:"header",name:"Authorization",description:"Bearer token for security"}},basedir:__dirname,files:["./routes/**/*.js"],contact:{name:"Antonio Aguilar",email:"jaguilar992@gmail.com",url:"github.com"}}},apis:["src/docs/**/*.yaml"]},$=e.n(F)()(Q),Y=t()();Y.use("/api/docs",z().serve,z().setup($,{SwaggerOptions:{url:"/api/docs/swagger.json"}})),Y.get("/docs/swagger.json",((e,n)=>n.json($))),Y.set("view engine","pug"),Y.set("views",__dirname+"/../views/"),c(),Y.use(o()),Y.use(t().json()),Y.use(t().urlencoded({extended:!0})),Y.use(t().static(__dirname+"/../public")),Y.use("/api/pokemon",T),Y.use("/api/trainer",_),Y.use("/views/pokemon",D),Y.use("/views/trainer",L),Y.get("/",((e,n)=>{n.render("index",{title:"Pokedex",message:"Welcome to the Pokedex",time:Date.now()})})),Y.listen(a,(()=>{f.info(`🔋 Server running on port::${a}`)})).on("error",(e=>{f.error(`🔥 Server error: ${e.message}`)}))})();